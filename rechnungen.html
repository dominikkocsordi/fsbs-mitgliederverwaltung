<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finanzen</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#111c2b;
      --bg3:#0b2a33;

      --glass: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.22);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);

      --accent1:#38bdf8;
      --accent2:#0ea5e9;

      --shadow: 0 20px 55px rgba(0,0,0,.40);

      --ok: rgba(34,197,94,.95);
      --bad: rgba(239,68,68,.95);
      --warn: rgba(251,146,60,.95);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(56,189,248,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(800px 450px at 60% 90%, rgba(251,113,133,.18), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      min-height:100vh;
      padding: 28px 16px 60px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .app{ width:100%; max-width:1200px; }

    .glass{
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    /* ===== Auth badge (kompakt + Details Toggle) ===== */
    .authFloating{
      border-radius: 999px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      user-select:none;
      max-width: min(560px, 100%);
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.35);
      position: relative;
      flex: 0 0 auto;
    }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: rgba(255,255,255,.35); }

    .authAvatar{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .3px;
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      background: rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .authAvatar.hidden{ display:none; }

    .authInfo{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      min-width:0;
      flex: 1 1 auto;
    }
    .authState{
      font-size:13px;
      font-weight:750;
      letter-spacing:.25px;
    }
    .authState.hidden{ display:none; }

    .authTopLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .authCompact{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .authCompact.hidden{ display:none; }

    .authNameInline{
      font-size:13px;
      font-weight:850;
      letter-spacing:.15px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }

    .authChevron{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      width: 30px; height: 26px;
      border-radius: 999px;
      padding: 0;
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease;
      flex: 0 0 auto;
    }
    .authChevron:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }

    .authDetails{
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .authDetails.hidden{ display:none; }

    .authMail{
      font-size:11px;
      color: rgba(255,255,255,.58);
      margin-top:0;
      word-break:break-all;
    }

    .rolePill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.82);
      font-weight:700;
      font-size: 11px;
      letter-spacing: .10px;
      line-height: 1;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .rolePill.vorstand{
      border-color: rgba(56,189,248,.40);
      background: rgba(56,189,248,.12);
    }
    .rolePill.other{
      border-color: rgba(251,146,60,.35);
      background: rgba(251,146,60,.12);
    }

    .hidden{ display:none; }

    /* Header + Controls */
    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 16px;
    }
    h1{ margin:0; font-size:28px; letter-spacing:.3px; }
    .subtitle{ margin-top:6px; color:var(--muted); font-size:14px; }

    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      font-size: 12px;
      color: rgba(255,255,255,.72);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill strong{ color: rgba(255,255,255,.92); font-weight:900; }

    /* NAV */
    .navWrap{
      position: sticky;
      top: 14px;
      z-index: 10;
      margin-bottom: 16px;
    }
    .nav{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding: 10px;
    }
    .navLeft{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .navRight{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .navLink{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      text-decoration:none;
      color: rgba(255,255,255,.86);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transition: transform .16s ease, filter .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
    }
    .navLink:hover{
      transform: translateY(-2px);
      filter: brightness(1.06);
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    .navLink.active{
      background: linear-gradient(135deg, rgba(56,189,248,.22), rgba(14,165,233,.12));
      border-color: rgba(56,189,248,.40);
      box-shadow: 0 14px 30px rgba(14,165,233,.18);
    }
    .navIcon{
      width:30px; height:30px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
    }
    .navTitle{ font-weight:750; letter-spacing:.2px; }
    .navHint{ font-size:12px; color: rgba(255,255,255,.60); margin-left:2px; }

    button{
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding: 10px 14px;
      font-weight:700;
      transition: transform .16s ease, filter .16s ease, opacity .16s ease, box-shadow .16s ease;
    }
    button:active{ transform: translateY(0px) scale(.99); }
    button:disabled{ cursor: not-allowed !important; opacity: .55 !important; transform:none !important; }

    .btn-secondary{
      background: rgba(255,255,255,.14);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover{ transform: translateY(-2px); background: rgba(255,255,255,.18); }

    .btn-primary{
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #03202b;
      box-shadow: 0 10px 26px rgba(14,165,233,.25);
    }
    .btn-primary:hover{ transform: translateY(-2px); filter: brightness(1.03); }

    .btn-danger{
      background: rgba(239,68,68,.16);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(239,68,68,.28);
    }
    .btn-danger:hover{ transform: translateY(-2px); filter: brightness(1.04); }

    .btn-warn{
      background: rgba(251,146,60,.16);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(251,146,60,.28);
    }
    .btn-warn:hover{ transform: translateY(-2px); filter: brightness(1.04); }

    .btn-ok{
      background: rgba(34,197,94,.16);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(34,197,94,.28);
    }
    .btn-ok:hover{ transform: translateY(-2px); filter: brightness(1.04); }

    .card{ padding:16px; margin-bottom:14px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    input,select{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      outline:none;
      min-width: 190px;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    input::placeholder{ color: rgba(255,255,255,.55); }
    input:focus, select:focus{
      border-color: rgba(56,189,248,.55);
      background: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }

    /* KPIs */
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
      margin-top: 10px;
    }
    @media (max-width: 1020px){ .kpiGrid{grid-template-columns: repeat(2, minmax(0,1fr));} }

    .kpi{
      padding: 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .kpi .k{ color: rgba(255,255,255,.70); font-size:12px; }
    .kpi .v{ font-size: 20px; font-weight: 900; letter-spacing:.2px; margin-top:6px; }
    .kpi .h{ color: rgba(255,255,255,.60); font-size:12px; margin-top:4px; }

    /* Cards grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:14px;
    }
    @media (max-width: 1020px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 640px){
      .grid{grid-template-columns: 1fr;}
      input,select{min-width:0; width:100%;}
      .top{ flex-direction:column; align-items:flex-start; gap:10px; }
      .authNameInline{ max-width: 150px; }

      /* mobile nav scroll */
      .nav{ flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling: touch; }
      .navLeft{ flex-wrap:nowrap; }
      .navRight{ margin-left: 0; flex-wrap:nowrap; }
      .navRight button{ white-space:nowrap; }

      /* controls stacked, less cramped */
      .card .row{ gap:10px; }
      button{ width:100%; }
      .row .spacer{ display:none; }
    }

    .appCard{
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: 22px;
      box-shadow: 0 14px 55px rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      cursor:pointer;
      transition: transform .18s ease, filter .18s ease, border-color .18s ease;
      overflow:hidden;
      position: relative;
      padding: 14px;
    }
    .appCard:hover{ transform: translateY(-2px); filter: brightness(1.05); border-color: rgba(255,255,255,.28); }

    .cardTop{ display:flex; align-items:flex-start; gap:12px; min-width:0; }
    .iconBox{
      width:44px; height:44px; border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      flex:0 0 auto;
      font-weight:900;
      color: rgba(255,255,255,.80);
    }
    .cardText{ min-width:0; flex:1 1 auto; }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin-top:4px;
      color: rgba(255,255,255,.62);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .metaRow{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .metaPill{
      font-size:12px;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .statusPill{
      position:absolute;
      top:10px;
      right:10px;
      font-size:12px;
      font-weight:900;
      padding:7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .statusPill.open{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.28); color:#fecaca; }
    .statusPill.check{ background: rgba(251,146,60,.16); border-color: rgba(251,146,60,.28); color:#fed7aa; }
    .statusPill.paid{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.28); color:#bbf7d0; }

    .empty{
      margin-top: 12px;
      padding: 18px;
      border-radius: 22px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.78);
    }

    /* Modal */
    .modalOverlay{
      position: fixed; inset:0; z-index:50;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:min(920px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius: 26px;
      padding: 16px;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 10px;
    }
    .modalTitle{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .modalSub{ margin-top:6px; color: var(--muted); font-size: 13px; }
    .closeX{ width:42px; height:42px; border-radius:14px; }

    .kv{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap: 10px 14px;
      padding: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      margin-top: 12px;
    }
    @media (max-width: 760px){ .kv{grid-template-columns: 1fr;} }
    .k{ color: rgba(255,255,255,.70); font-size:12px; }
    .v{ color: rgba(255,255,255,.92); white-space:pre-wrap; overflow-wrap:anywhere; }
    .v a{ color: rgba(180,210,255,.95); }

    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .split{ display:flex; gap:12px; flex-wrap:wrap; margin-top: 10px; }
    .split > *{ flex: 1 1 260px; }

    .denyBox{
      padding: 18px;
      border-radius: 22px;
      border: 1px solid rgba(239,68,68,.28);
      background: rgba(239,68,68,.10);
      color: rgba(255,255,255,.90);
    }

    .debug{
      display:none;
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.84);
      font-size: 12px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .debug.show{ display:block; }
  </style>
</head>

<body>
  <div class="app">

    <div class="top">
      <div>
        <h1>Finanzen</h1>
        <div class="subtitle">Rechnungen & Auslagen</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <div class="pill" id="statusPill">‚Äì</div>

        <div class="authFloating" id="authBadge" title="Login-Status">
          <span class="dot warn" id="authDot"></span>
          <div class="authAvatar hidden" id="authAvatar">U</div>

          <div class="authInfo">
            <div class="authTopLine">
              <div class="authState" id="authState">nicht eingeloggt</div>

              <div class="authCompact hidden" id="authCompact">
                <span class="authNameInline" id="authNameInline">User</span>
                <span class="rolePill other" id="authRolePill">rolle</span>
                <button class="authChevron" id="authToggle" aria-label="Details">‚åÑ</button>
              </div>
            </div>

            <div class="authDetails hidden" id="authDetails">
              <div class="authMail" id="authMail"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- NAV (wird NUR f√ºr Vorstand sichtbar geschaltet) -->
    <div class="glass navWrap" id="navWrap" style="display:none;">
      <div class="nav">
        <div class="navLeft">
          <a class="navLink" href="/index.html">
            <span class="navIcon">üë•</span>
            <span>
              <div class="navTitle">Mitglieder</div>
              <div class="navHint">Verwalten</div>
            </span>
          </a>

          <a class="navLink" href="/anwaerter.html">
            <span class="navIcon">üë∂üèº</span>
            <span>
              <div class="navTitle">Anw√§rter</div>
              <div class="navHint">Liste</div>
            </span>
          </a>

          <a class="navLink" href="/bewerbungen.html">
            <span class="navIcon">üìù</span>
            <span>
              <div class="navTitle">Bewerbungen</div>
              <div class="navHint">Google Sheet</div>
            </span>
          </a>

          <a class="navLink active" href="/rechnungen.html">
            <span class="navIcon">üí∞</span>
            <span>
              <div class="navTitle">Finanzen</div>
              <div class="navHint">Rechnungen</div>
            </span>
          </a>
        </div>

        <div class="navRight">
          <!-- ‚úÖ Belege-Link wird nur f√ºr Vorstand angezeigt -->
          <a class="navLink" id="belegeNavLink" href="https://drive.google.com/drive/folders/1HRpbFYmXV-hL-CUD-A-AbZvjZiT1eDPuziX_V52G15Gs3DIDKGG1tsQGvx_rlZJYo7C_HJxF?usp=sharing" target="_blank" rel="noopener" style="display:none;">
            <span class="navIcon">üìÅ</span>
            <span>
              <div class="navTitle">Belege</div>
              <div class="navHint">Drive</div>
            </span>
          </a>

          <button class="btn-secondary" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>

    <!-- Zugriff verweigert -->
    <div class="glass card" id="denyWrap" style="display:none;">
      <div class="denyBox">
        <div style="font-weight:900; font-size:16px;">Kein Zugriff</div>
        <div style="margin-top:6px; color:rgba(255,255,255,.78);">
          Diese Seite ist nur f√ºr <b>vorstand</b>.
        </div>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn-secondary" id="logoutBtn2">Logout</button>
          <a class="pill" href="/index.html" style="text-decoration:none;">Zur Startseite</a>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="glass card" id="kpiCard" style="display:none;">
      <div class="row" style="align-items:flex-start;">
        <div>
          <div style="font-weight:900; font-size:16px;">√úbersicht</div>
        </div>
        <div class="spacer"></div>
        <div class="pill" id="countPill">0</div>
      </div>

      <div class="kpiGrid">
        <div class="kpi">
          <div class="k">Rechnung offen</div>
          <div class="v" id="kpiOpenSum">‚Äì</div>
          <div class="h" id="kpiOpenCount">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="k">In Pr√ºfung</div>
          <div class="v" id="kpiCheckSum">‚Äì</div>
          <div class="h" id="kpiCheckCount">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="k">Bezahlt</div>
          <div class="v" id="kpiPaidSum">‚Äì</div>
          <div class="h" id="kpiPaidCount">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="k">Gesamt</div>
          <div class="v" id="kpiTotalSum">‚Äì</div>
          <div class="h" id="kpiTotalCount">‚Äì</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="glass card" id="controlsCard" style="display:none;">
      <div class="row">
        <input id="q" placeholder="Suche (Name, Projekt, IBAN, Erl√§uterung‚Ä¶)" />
        <select id="fStatus">
          <option value="">Status (alle)</option>
          <option value="Rechnung offen">Rechnung offen</option>
          <option value="In Pr√ºfung">In Pr√ºfung</option>
          <option value="Bezahlt">Bezahlt</option>
        </select>
        <select id="fProj"><option value="">Projekt (alle)</option></select>

        <button class="btn-secondary" id="reloadBtn">Neu laden</button>
        <button class="btn-primary" id="exportBtn">Export CSV</button>

        <div class="spacer"></div>
        <div class="pill" style="opacity:.9;">Klick auf Karte ‚Üí Details & Status</div>
      </div>

      <div class="debug" id="debugBox"></div>
    </div>

    <div id="grid" class="grid" style="display:none;"></div>
    <div id="empty" class="empty" style="display:none;">Keine Einreichungen gefunden.</div>

  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="glass modal" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div>
          <h2 class="modalTitle" id="modalTitle">Rechnung</h2>
          <div class="modalSub" id="modalSub">‚Äì</div>
        </div>
        <button class="btn-secondary closeX" id="closeModalBtn">‚úï</button>
      </div>

      <div class="split">
        <div class="glass" style="border-radius:18px; padding:12px;">
          <div style="font-weight:900; margin-bottom:8px;">Status setzen</div>
          <div class="row" style="gap:10px;">
            <button class="btn-danger" id="setOpenBtn">Rechnung offen</button>
            <button class="btn-warn" id="setCheckBtn">In Pr√ºfung</button>
            <button class="btn-ok" id="setPaidBtn">Bezahlt</button>
            <a class="pill" id="belegLink" href="#" target="_blank" rel="noopener" style="text-decoration:none; display:none;">üìé Beleg √∂ffnen</a>
          </div>
        </div>

        <div class="glass" style="border-radius:18px; padding:12px;">
          <div style="font-weight:900; margin-bottom:8px;">Kurzinfo</div>
          <div class="pill"><span>Ausgew√§hlt:</span> <strong id="selName">‚Äì</strong></div>
          <div class="pill" style="margin-top:10px;"><span>Summe:</span> <strong id="selSum">‚Äì</strong></div>
          <div class="pill" style="margin-top:10px;"><span>Status:</span> <strong id="selStatus">‚Äì</strong></div>
        </div>
      </div>

      <div class="kv" id="kv"></div>

      <div class="modalActions">
        <button class="btn-secondary" id="closeModalBtn2">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // ‚úÖ KONFIG
    // ==========================
    const APP_URL = "https://script.google.com/macros/s/AKfycbxvGgyKd8-zZ87ZvB1lPX4WcVpv5KYvx7ikEYxhvgDtJ4I8XOmAvT_IsIB5p4vloc3A/exec";

    const SUPABASE_URL = "https://hdhueuihmxbskiusenpe.supabase.co";
    const SUPABASE_KEY = "sb_publishable_H6YjVStNvwY-VnZuZCYDxw_mOWEvAAW";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const LOGIN_REDIRECT = "/index.html";
    const PROFILES_TABLE = "profiles";
    const REQUIRED_ROLE = "vorstand"; // ‚úÖ exakt so, kleinschreibung

    const F = {
      ts: "Zeitstempel",
      fn: "Vorname",
      ln: "Nachname",
      desc: "Beleg Erl√§uterung",
      proj: "Projekt",
      sum: "Beleg Summe",
      date: "Beleg Datum",
      status: "Status",
      beleg: "Beleg hochladen",
      iban: "Dein IBAN"
    };

    // ==========================
    // Elements
    // ==========================
    const navWrap = document.getElementById("navWrap");
    const belegeNavLink = document.getElementById("belegeNavLink");
    const logoutBtn = document.getElementById("logoutBtn");
    const logoutBtn2 = document.getElementById("logoutBtn2");

    const statusPill = document.getElementById("statusPill");
    const countPill = document.getElementById("countPill");

    const denyWrap = document.getElementById("denyWrap");
    const kpiCard = document.getElementById("kpiCard");
    const controlsCard = document.getElementById("controlsCard");
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");

    const q = document.getElementById("q");
    const fStatus = document.getElementById("fStatus");
    const fProj = document.getElementById("fProj");
    const reloadBtn = document.getElementById("reloadBtn");
    const exportBtn = document.getElementById("exportBtn");
    const debugBox = document.getElementById("debugBox");

    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const kv = document.getElementById("kv");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const closeModalBtn2 = document.getElementById("closeModalBtn2");

    const setOpenBtn = document.getElementById("setOpenBtn");
    const setCheckBtn = document.getElementById("setCheckBtn");
    const setPaidBtn = document.getElementById("setPaidBtn");
    const belegLink = document.getElementById("belegLink");

    const selName = document.getElementById("selName");
    const selSum = document.getElementById("selSum");
    const selStatus = document.getElementById("selStatus");

    // Auth badge
    const authBadge = document.getElementById("authBadge");
    const authDot = document.getElementById("authDot");
    const authState = document.getElementById("authState");
    const authMail  = document.getElementById("authMail");
    const authAvatar = document.getElementById("authAvatar");
    const authCompact = document.getElementById("authCompact");
    const authNameInline = document.getElementById("authNameInline");
    const authRolePill = document.getElementById("authRolePill");
    const authToggle = document.getElementById("authToggle");
    const authDetails = document.getElementById("authDetails");

    // ==========================
    // State
    // ==========================
    const safe = (v) => (v === null || v === undefined) ? "" : String(v);
    const esc = (s) => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    let MY_ROLE = "";
    let CAN_VIEW = false;
    let TOKEN = null;

    let ALL = [];
    let ACTIVE_ROW = null;

    function showDebug(obj){
      debugBox.classList.add("show");
      debugBox.textContent = JSON.stringify(obj, null, 2);
    }

    // ==========================
    // PRICE
    // ==========================
    function parseEUR(v){
      if (typeof v === "number" && Number.isFinite(v)) return v;
      const raw = safe(v).trim();
      if (!raw) return 0;

      const s = raw.replace(/\s/g,"").replace(/[^\d.,-]/g,"");
      const hasDot = s.includes(".");
      const hasComma = s.includes(",");

      if (hasDot && hasComma){
        const norm = s.replace(/\./g,"").replace(",",".");
        const n = Number(norm);
        return Number.isFinite(n) ? n : 0;
      }
      if (hasComma && !hasDot){
        const n = Number(s.replace(",","."));
        return Number.isFinite(n) ? n : 0;
      }
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    const fmtEUR = (n)=> new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(n||0);

    function tsKey(row){ return safe(row?.[F.ts]).trim(); }

    function statusNorm(s){
      const t = safe(s).trim();
      if (!t) return "Rechnung offen";
      const low = t.toLowerCase();
      if (low.includes("pr√ºfung")) return "In Pr√ºfung";
      if (low.includes("bezahlt")) return "Bezahlt";
      if (low.includes("offen")) return "Rechnung offen";
      return t;
    }
    function statusClass(st){
      if (st === "Bezahlt") return "paid";
      if (st === "In Pr√ºfung") return "check";
      return "open";
    }
    function uniq(arr){
      return [...new Set(arr.map(x => safe(x).trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"de"));
    }

    // ==========================
    // Badge helpers
    // ==========================
    function hashString(str){
      let h = 2166136261;
      for (let i = 0; i < str.length; i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    function initialsFromEmail(email){
      const e = (email || "").trim().toLowerCase();
      if (!e) return "U";
      const local = e.split("@")[0] || "u";
      const parts = local.split(/[.\-_]+/).filter(Boolean);
      const a = (parts[0]?.[0] || local[0] || "u").toUpperCase();
      const b = (parts[1]?.[0] || local[1] || "").toUpperCase();
      return (a + b).trim() || a;
    }
    function initialsFromText(txt){
      const t = (txt || "").trim();
      if (!t) return "U";
      const parts = t.split(/\s+/).filter(Boolean);
      const a = (parts[0]?.[0] || "U").toUpperCase();
      const b = (parts[1]?.[0] || "").toUpperCase();
      return (a + b).trim() || a;
    }
    function setAvatar(email){
      const e = (email || "").trim().toLowerCase();
      if (!e){
        authAvatar.classList.add("hidden");
        authAvatar.textContent = "U";
        authAvatar.style.background = "rgba(255,255,255,.10)";
        return;
      }
      const h = hashString(e);
      const hue = h % 360;
      const hue2 = (hue + 38) % 360;
      authAvatar.textContent = initialsFromEmail(e);
      authAvatar.classList.remove("hidden");
      authAvatar.style.background = `linear-gradient(135deg, hsla(${hue}, 85%, 55%, .55), hsla(${hue2}, 85%, 55%, .35))`;
    }
    function closeAuthDetails(){ authDetails.classList.add("hidden"); }
    authToggle?.addEventListener("click", (e)=>{
      e.stopPropagation();
      authDetails.classList.toggle("hidden");
    });
    document.addEventListener("click", (e)=>{
      if (authBadge && !authBadge.contains(e.target)) closeAuthDetails();
    });

    function normRole(v){
      return String(v || "").replace(/\s+/g," ").trim().toLowerCase();
    }
    function setRolePill(role){
      const r = normRole(role);
      authRolePill.textContent = r || "unbekannt";
      authRolePill.classList.remove("vorstand","other");
      if (r === "vorstand") authRolePill.classList.add("vorstand");
      else authRolePill.classList.add("other");
    }
    function setCompactIdentity(displayName, email){
      const name = (displayName || "").trim();
      const fallback = ((email || "").split("@")[0] || "User").trim();
      authNameInline.textContent = name || fallback;
    }

    // ‚úÖ Nav/Content harte Freigabe
    function applyAccessUI(allowed){
      CAN_VIEW = !!allowed;

      // NAV + Drive Link nur f√ºr Vorstand
      navWrap.style.display = allowed ? "block" : "none";
      belegeNavLink.style.display = allowed ? "inline-flex" : "none";

      // Content
      denyWrap.style.display = allowed ? "none" : "block";
      kpiCard.style.display = allowed ? "block" : "none";
      controlsCard.style.display = allowed ? "block" : "none";
      grid.style.display = allowed ? "grid" : "none";

      if (!allowed){
        // ‚úÖ Sensitive UI weg
        empty.style.display = "none";
        grid.innerHTML = "";
        ALL = [];
        TOKEN = null;
      }
    }

    function setAuthUI(isAuthed, email=""){
      if (isAuthed){
        authDot.classList.remove("warn"); authDot.classList.add("ok");
        authState.classList.add("hidden");
        authCompact.classList.remove("hidden");
        authMail.textContent = (email || "").trim();
        setAvatar(email);
      } else {
        authDot.classList.remove("ok"); authDot.classList.add("warn");
        authState.classList.remove("hidden");
        authState.textContent = "nicht eingeloggt";
        authCompact.classList.add("hidden");
        authMail.textContent = "";
        setAvatar("");
      }
    }

    // ==========================
    // Auth + Permissions
    // ==========================
    async function requireAuth(){
      const res = await sb.auth.getSession();
      if (!res?.data?.session) throw new Error("not_logged_in");
      return res.data.session;
    }

    async function loadMyProfile(session){
      MY_ROLE = "";
      const uid = session?.user?.id;
      const email = session?.user?.email || "";

      const { data, error } = await sb
        .from(PROFILES_TABLE)
        .select("role, display_name")
        .eq("id", uid)
        .maybeSingle();

      if (error || !data){
        setCompactIdentity("", email);
        setRolePill("");
        return "";
      }

      MY_ROLE = normRole(data?.role);
      setCompactIdentity(data?.display_name, email);
      setRolePill(MY_ROLE);

      const dn = (data?.display_name || "").trim();
      if (dn) authAvatar.textContent = initialsFromText(dn);

      return MY_ROLE;
    }

    async function loadFinanceToken(){
      const { data, error } = await sb
        .from("app_secrets")
        .select("value")
        .eq("key","finance_sheet_token")
        .maybeSingle();

      if (error) throw error;
      return data?.value || "";
    }

    async function enforceAuth(){
      try{
        const session = await requireAuth();
        const mail = session?.user?.email || "";
        setAuthUI(true, mail);

        const role = await loadMyProfile(session);
        const allowed = (role === REQUIRED_ROLE);

        if (!allowed){
          statusPill.textContent = "Kein Zugriff";
          applyAccessUI(false);
          return;
        }

        applyAccessUI(true);

        TOKEN = await loadFinanceToken();
        if (!TOKEN){
          statusPill.textContent = "Fehlt: finance_sheet_token";
          showDebug({hint:"Supabase app_secrets: key=finance_sheet_token (RLS nur vorstand)."});
          return;
        }

      } catch(e){
        setAuthUI(false);
        window.location.href = LOGIN_REDIRECT;
      }
    }

    async function doLogout(){
      await sb.auth.signOut();
      window.location.href = "/index.html";
    }
    logoutBtn?.addEventListener("click", doLogout);
    logoutBtn2?.addEventListener("click", doLogout);

    // ==========================
    // API
    // ==========================
    async function apiGetRows(){
      const url = `${APP_URL}?token=${encodeURIComponent(TOKEN)}`;
      const res = await fetch(url, { method:"GET" });
      const text = await res.text();

      let json;
      try { json = JSON.parse(text); }
      catch(err){ throw new Error("API liefert kein JSON: " + text.slice(0,200)); }

      if (!res.ok) throw new Error("API Fehler: " + res.status);
      if (json?.error) throw new Error("API: " + json.error);
      return Array.isArray(json.rows) ? json.rows : [];
    }

    async function apiSetStatus(timestamp, status){
      const url = `${APP_URL}?token=${encodeURIComponent(TOKEN)}`;
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ timestamp, status, token: TOKEN })
      });
      const t = await res.text();
      if (!res.ok) throw new Error("POST failed: " + res.status + " " + t.slice(0,200));
    }

    // ==========================
    // Data & UI
    // ==========================
    function filtered(){
      const text = safe(q.value).trim().toLowerCase();
      const st = safe(fStatus.value).trim();
      const pr = safe(fProj.value).trim();

      return ALL.filter(r=>{
        const s = statusNorm(r[F.status]);
        if (st && s !== st) return false;
        if (pr && safe(r[F.proj]).trim() !== pr) return false;

        if (text){
          const blob = [r[F.fn], r[F.ln], r[F.proj], r[F.iban], r[F.desc]].map(safe).join(" ").toLowerCase();
          if (!blob.includes(text)) return false;
        }
        return true;
      });
    }

    function updateKPIs(){
      const sum = (rows)=> rows.reduce((a,r)=> a + parseEUR(r[F.sum]), 0);

      const open = ALL.filter(r => statusNorm(r[F.status]) === "Rechnung offen");
      const check = ALL.filter(r => statusNorm(r[F.status]) === "In Pr√ºfung");
      const paid = ALL.filter(r => statusNorm(r[F.status]) === "Bezahlt");

      document.getElementById("kpiOpenSum").textContent = fmtEUR(sum(open));
      document.getElementById("kpiOpenCount").textContent = `${open.length} Vorgang/Vorg√§nge`;

      document.getElementById("kpiCheckSum").textContent = fmtEUR(sum(check));
      document.getElementById("kpiCheckCount").textContent = `${check.length} Vorgang/Vorg√§nge`;

      document.getElementById("kpiPaidSum").textContent = fmtEUR(sum(paid));
      document.getElementById("kpiPaidCount").textContent = `${paid.length} Vorgang/Vorg√§nge`;

      document.getElementById("kpiTotalSum").textContent = fmtEUR(sum(ALL));
      document.getElementById("kpiTotalCount").textContent = `${ALL.length} gesamt`;
    }

    function fillProjectFilter(){
      const projects = uniq(ALL.map(r => r[F.proj]));
      fProj.innerHTML = `<option value="">Projekt (alle)</option>` + projects.map(p => `<option value="${esc(p)}">${esc(p)}</option>`).join("");
    }

    function render(){
      if (!CAN_VIEW) return;

      const rows = filtered();
      countPill.textContent = `${rows.length} / ${ALL.length}`;
      statusPill.textContent = `Geladen: ${ALL.length}`;

      grid.innerHTML = "";
      empty.style.display = rows.length ? "none" : "block";

      rows.forEach(r=>{
        const fn = safe(r[F.fn]).trim();
        const ln = safe(r[F.ln]).trim();
        const name = (fn + " " + ln).trim() || "Unbekannt";
        const proj = safe(r[F.proj]).trim() || "‚Äî";
        const sum = parseEUR(r[F.sum]);
        const st = statusNorm(r[F.status]);
        const stCls = statusClass(st);

        const card = document.createElement("div");
        card.className = "appCard";
        card.innerHTML = `
          <div class="statusPill ${stCls}">${esc(st)}</div>
          <div class="cardTop">
            <div class="iconBox">‚Ç¨</div>
            <div class="cardText">
              <div class="title">${esc(name)}</div>
              <div class="sub">${esc(proj)}</div>
            </div>
          </div>
          <div class="metaRow">
            <span class="metaPill">üí∂ <strong>${esc(fmtEUR(sum))}</strong></span>
            ${safe(r[F.beleg]).trim().startsWith("http") ? `<span class="metaPill">üìé Beleg vorhanden</span>` : ``}
          </div>
        `;
        card.addEventListener("click", ()=> openModal(r));
        grid.appendChild(card);
      });
    }

    function openModal(row){
      if (!CAN_VIEW) return;
      ACTIVE_ROW = row;

      const fn = safe(row[F.fn]).trim();
      const ln = safe(row[F.ln]).trim();
      const name = (fn + " " + ln).trim() || "Rechnung";

      const ts = tsKey(row);
      const proj = safe(row[F.proj]).trim();
      const date = safe(row[F.date]).trim();
      const st = statusNorm(row[F.status]);
      const sum = parseEUR(row[F.sum]);

      modalTitle.textContent = name;
      modalSub.textContent = [proj, date].filter(Boolean).join(" ¬∑ ") || "‚Äî";

      selName.textContent = name;
      selSum.textContent = fmtEUR(sum);
      selStatus.textContent = st;

      const beleg = safe(row[F.beleg]).trim();
      if (beleg && beleg.startsWith("http")){
        belegLink.href = beleg;
        belegLink.style.display = "inline-flex";
      } else {
        belegLink.style.display = "none";
      }

      const items = [
        ["Projekt", safe(row[F.proj])],
        ["Beleg Summe", fmtEUR(sum)],
        ["Beleg Datum", safe(row[F.date])],
        ["Status", st],
        ["Beleg Erl√§uterung", safe(row[F.desc])],
        ["Beleg hochladen", safe(row[F.beleg])],
        ["Dein IBAN", safe(row[F.iban])],
        ["Zeitstempel", safe(row[F.ts])]
      ];

      kv.innerHTML = "";
      items.forEach(([k,val])=>{
        const dk = document.createElement("div");
        dk.className = "k";
        dk.textContent = k;

        const dv = document.createElement("div");
        dv.className = "v";
        const v = safe(val).trim();

        if (v.startsWith("http")){
          dv.innerHTML = `<a href="${esc(v)}" target="_blank" rel="noopener">${esc(v)}</a>`;
        } else {
          dv.textContent = v || "‚Äî";
        }
        kv.appendChild(dk);
        kv.appendChild(dv);
      });

      modalOverlay.classList.add("show");
    }

    function closeModal(){
      modalOverlay.classList.remove("show");
      ACTIVE_ROW = null;
    }

    async function fetchRows(){
      if (!CAN_VIEW) return;

      statusPill.textContent = "Lade‚Ä¶";
      try{
        ALL = await apiGetRows();

        // default status
        ALL = ALL.map(r=>{
          if (!safe(r[F.status]).trim()) r[F.status] = "Rechnung offen";
          return r;
        });

        fillProjectFilter();
        updateKPIs();
        render();
      } catch(err){
        statusPill.textContent = "API Fehler";
        showDebug({error: String(err)});
      }
    }

    async function setStatusFor(ts, status){
      if (!CAN_VIEW) return;
      try{
        await apiSetStatus(ts, status);
        const i = ALL.findIndex(r => tsKey(r) === ts);
        if (i >= 0) ALL[i][F.status] = status;
        updateKPIs();
        render();
        if (ACTIVE_ROW && tsKey(ACTIVE_ROW) === ts) {
          ACTIVE_ROW[F.status] = status;
          selStatus.textContent = statusNorm(status);
        }
      } catch(err){
        alert("Konnte Status nicht setzen: " + (err?.message || err));
      }
    }

    function exportCSV(){
      if (!CAN_VIEW) return;

      const headers = [F.ts,F.fn,F.ln,F.proj,F.sum,F.date,F.status,F.desc,F.beleg,F.iban];
      const lines = [headers.join(";")];

      const rows = filtered();
      rows.forEach(r=>{
        const row = headers.map(h=>{
          const s = safe(r[h]).replaceAll('"','""');
          return `"${s}"`;
        });
        lines.push(row.join(";"));
      });

      const blob = new Blob(["\uFEFF"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `rechnungen_export_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Events
    [q, fStatus, fProj].forEach(elm => elm?.addEventListener("input", render));
    reloadBtn?.addEventListener("click", fetchRows);
    exportBtn?.addEventListener("click", exportCSV);

    setOpenBtn?.addEventListener("click", ()=> ACTIVE_ROW && setStatusFor(tsKey(ACTIVE_ROW), "Rechnung offen"));
    setCheckBtn?.addEventListener("click", ()=> ACTIVE_ROW && setStatusFor(tsKey(ACTIVE_ROW), "In Pr√ºfung"));
    setPaidBtn?.addEventListener("click", ()=> ACTIVE_ROW && setStatusFor(tsKey(ACTIVE_ROW), "Bezahlt"));

    closeModalBtn?.addEventListener("click", closeModal);
    closeModalBtn2?.addEventListener("click", closeModal);
    modalOverlay?.addEventListener("click", (e)=>{ if (e.target === modalOverlay) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(); });

    // Init
    (async function init(){
      // default locked down until permission is known
      applyAccessUI(false);
      await enforceAuth();
      if (!CAN_VIEW) return;
      if (!TOKEN){ statusPill.textContent = "Token nicht geladen"; return; }
      await fetchRows();
    })();
  </script>
</body>
</html>
