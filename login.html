<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FSBS Intern – Login</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#120e18;
      --bg2:#1a1424;
      --bg3:#1f162c;

      --accent1:#f97316;   /* orange */
      --accent2:#a855f7;   /* purple */

      --glass: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.18);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);

      --shadow: 0 20px 55px rgba(0,0,0,.45);

      --ok: rgba(34,197,94,.95);
      --bad: rgba(239,68,68,.95);
    }

    *{box-sizing:border-box}
    html, body{min-height:100%}

    html{
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(249,115,22,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(168,85,247,.22), transparent 60%),
        radial-gradient(800px 450px at 60% 90%, rgba(124,58,237,.18), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      background-attachment: fixed;
    }

    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color: var(--text);
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 42px 16px;
    }

    .app{
      width: min(560px, 100%);
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    .brandLeft{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .brandLogo{
      width: 52px;
      height: 52px;
      border-radius: 14px;
      padding: 6px;
      display:grid;
      place-items:center;

      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 16px 44px rgba(0,0,0,.30);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);

      flex: 0 0 auto;
      transition: transform .16s ease, filter .16s ease, background .16s ease;
      text-decoration:none;
      color: rgba(255,255,255,.92);
      font-weight: 850;
      letter-spacing: .2px;
      font-size: 14px;
    }

    .brandLogo:hover{
      transform: translateY(-1px);
      filter: brightness(1.05);
      background: rgba(255,255,255,.12);
    }

    .brandLogo img{
      width: 100%;
      height: 100%;
      border-radius: 10px;
      object-fit: cover;
      display:block;
    }

    @media (max-width: 420px){
      .brandLogo{ width: 44px; height: 44px; border-radius: 13px; padding: 5px; }
      .brandLogo img{ border-radius: 9px; }
    }

    .titles{min-width:0}
    .titles h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .25px;
      line-height: 1.15;
    }
    .subtitle{
      margin-top: 4px;
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .glass{
      background: rgba(255,255,255,.10);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .card{ padding:18px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.15);
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
      outline:none;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    input:focus{
      border-color: rgba(249,115,22,.55);
      background: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }
    input::placeholder{ color: rgba(255,255,255,.55); }

    .grid{ display:grid; gap: 12px; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }

    button{
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding: 12px 16px;
      font-weight:650;
      transition: transform .16s ease, filter .16s ease, opacity .16s ease, box-shadow .16s ease, background .16s ease, border-color .16s ease;
    }
    button:active{ transform: translateY(0px) scale(.99); }

    button:disabled{
      cursor:not-allowed !important;
      opacity:.55 !important;
      transform:none !important;
      filter:none !important;
      box-shadow:none !important;
    }

    .btn-primary{
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #0f0b16;
      box-shadow: 0 12px 30px rgba(168,85,247,.25);
    }
    /* ✅ Hover NICHT blau */
    .btn-primary:hover{
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow:
        0 18px 36px rgba(249,115,22,.25),
        0 0 40px rgba(168,85,247,.25);
    }

    .btn-secondary{
      background: rgba(255,255,255,.14);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.18);
    }
    .btn-secondary:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.26);
    }

    .btn-purple{
      background: linear-gradient(135deg, rgba(168,85,247,.22), rgba(0,0,0,.10));
      color: var(--text);
      border: 1px solid rgba(168,85,247,.45);
      box-shadow: 0 12px 30px rgba(168,85,247,.18);
    }
    .btn-purple:hover{
      transform: translateY(-2px);
      filter: brightness(1.03);
      box-shadow: 0 18px 36px rgba(168,85,247,.22);
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    .note{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }

    .msg{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .msg.ok{ color: rgba(34,197,94,.95); }
    .msg.bad{ color: rgba(239,68,68,.95); }

    .hidden{ display:none !important; }

    footer{
      margin-top: 14px;
      text-align:center;
      color: rgba(255,255,255,.55);
      font-size: 12px;
    }
    footer strong{
      color: rgba(255,255,255,.78);
      font-weight: 750;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brandLeft">
        <a class="brandLogo" href="index.html" title="Fachschaft Business School e.V.">
          <img src="logo.png" alt="Fachschaft Logo"
               onerror="this.style.display='none'; this.parentElement.textContent='FS';" />
        </a>
        <div class="titles">
          <h1>FSBS Intern</h1>
          <div class="subtitle">Vorstand & Ressortleitung · Login</div>
        </div>
      </div>

      <div class="badge" title="Login-Status">
        <span class="dot bad" id="statusDot"></span>
        <span id="statusText">nicht eingeloggt</span>
      </div>
    </div>

    <div class="glass card">
      <!-- INVITE / RECOVERY: Passwort setzen -->
      <section id="inviteSection" class="hidden">
        <div class="note" id="inviteNote">Bitte lege jetzt dein Passwort fest.</div>
        <div class="divider"></div>

        <div class="grid">
          <div>
            <label for="invPw1">Neues Passwort</label>
            <input id="invPw1" type="password" autocomplete="new-password" placeholder="mind. 8 Zeichen" />
          </div>
          <div>
            <label for="invPw2">Passwort wiederholen</label>
            <input id="invPw2" type="password" autocomplete="new-password" placeholder="wiederholen" />
          </div>

          <div class="row">
            <button class="btn-primary" id="btnSetPassword">Passwort speichern</button>
            <button class="btn-secondary hidden" id="btnContinue">Weiter</button>
            <button class="btn-secondary" id="btnInviteCancel">Abbrechen</button>
          </div>

          <div id="inviteMsg" class="msg"></div>
        </div>
      </section>

      <!-- LOGIN -->
      <section id="loginSection">
        <div class="grid">
          <div>
            <label for="email">E-Mail</label>
            <input id="email" type="email" autocomplete="email" placeholder="name@domain.de" />
          </div>
          <div>
            <label for="password">Passwort</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="dein Passwort" />
          </div>

          <div class="row">
            <button class="btn-primary" id="btnLoginPw">Login</button>
            <button class="btn-purple" id="btnMagicLink">Login-Link per Mail</button>
            <button class="btn-secondary" id="btnForgotPw">Passwort vergessen?</button>
            <button class="btn-secondary hidden" id="btnLogout">Logout</button>
          </div>

          <div class="note">
            Tipp: “Passwort vergessen?” schickt dir einen Link zum Zurücksetzen.
          </div>

          <div id="loginMsg" class="msg"></div>
        </div>
      </section>
    </div>

    <footer>
      <strong>Fachschaft Business School e.V.</strong> · portal.fsbs-hm.de
    </footer>
  </div>

<script>
  // ========= SUPABASE =========
  const SUPABASE_URL = "https://hdhueuihmxbskiusenpe.supabase.co";
  const SUPABASE_KEY = "sb_publishable_H6YjVStNvwY-VnZuZCYDxw_mOWEvAAW";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const APP_REDIRECT = "index.html";
  const REDIRECT_TO = "https://portal.fsbs-hm.de/login.html";

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  function setStatus(isAuthed){
    statusDot.classList.toggle("ok", !!isAuthed);
    statusDot.classList.toggle("bad", !isAuthed);
    statusText.textContent = isAuthed ? "eingeloggt" : "nicht eingeloggt";
  }

  function setMsg(el, text, kind){
    el.textContent = text || "";
    el.classList.remove("ok","bad");
    if (kind) el.classList.add(kind);
  }

  function getParam(name){
    // Supabase kann Hash (#...) ODER Query (?...) benutzen
    const fromHash = new URLSearchParams((location.hash || "").replace(/^#/, ""));
    const fromQuery = new URLSearchParams(location.search || "");
    return fromHash.get(name) ?? fromQuery.get(name);
  }

  function cleanUrlAll(){
    // entfernt Hash + Query (Tokens/Codes nicht stehen lassen)
    const clean = location.origin + location.pathname;
    history.replaceState(null, "", clean);
  }

  function showInvite(){
    document.getElementById("inviteSection").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");
  }
  function showLogin(){
    document.getElementById("inviteSection").classList.add("hidden");
    document.getElementById("loginSection").classList.remove("hidden");
  }

  async function init(){
    // ✅ PKCE-Fall: ?code=... => gegen Session tauschen
    const code = getParam("code");
    if (code){
      const { error } = await sb.auth.exchangeCodeForSession(location.href);
      if (error){
        setStatus(false);
        showLogin();
        setMsg(document.getElementById("loginMsg"), "Fehler beim Link: " + error.message, "bad");
        return;
      }
      cleanUrlAll();
    }

    const { data: { session } } = await sb.auth.getSession();

    const type = getParam("type"); // invite / recovery / magiclink / ...
    const isInviteOrRecovery = (type === "invite" || type === "recovery");

    setStatus(!!session);

    // Hash/Query bereinigen, sobald Session da ist
    if (session && (location.hash || location.search)) cleanUrlAll();

    // ✅ Invite/Recovery: Passwort setzen anzeigen
    if (session && isInviteOrRecovery){
      const note = document.getElementById("inviteNote");
      note.textContent = (type === "recovery")
        ? "Passwort zurücksetzen: Bitte lege jetzt ein neues Passwort fest."
        : "Einladung: Bitte lege jetzt dein Passwort fest.";
      showInvite();
      setMsg(document.getElementById("inviteMsg"), "Bitte lege jetzt dein Passwort fest.", null);
      return;
    }

    // ✅ Wenn bereits eingeloggt -> DIREKT ins Portal
    if (session){
      window.location.replace(APP_REDIRECT);
      return;
    }

    // Normaler Login
    showLogin();
  }

  // INVITE/RECOVERY: Passwort setzen
  document.getElementById("btnSetPassword").addEventListener("click", async () => {
    const msg = document.getElementById("inviteMsg");
    const pw1 = document.getElementById("invPw1").value.trim();
    const pw2 = document.getElementById("invPw2").value.trim();

    if (pw1.length < 8) return setMsg(msg, "Passwort muss mindestens 8 Zeichen haben.", "bad");
    if (pw1 !== pw2) return setMsg(msg, "Passwörter stimmen nicht überein.", "bad");

    setMsg(msg, "Speichere Passwort…", null);

    const { error } = await sb.auth.updateUser({ password: pw1 });
    if (error) return setMsg(msg, "Fehler: " + error.message, "bad");

    setStatus(true);
    setMsg(msg, "✅ Passwort gespeichert. Weiterleitung…", "ok");
    // ✅ direkt ins Portal (kein Extra Button nötig)
    setTimeout(() => window.location.replace(APP_REDIRECT), 350);
  });

  document.getElementById("btnInviteCancel").addEventListener("click", async () => {
    await sb.auth.signOut();
    setStatus(false);
    showLogin();
    setMsg(document.getElementById("loginMsg"), "Abgebrochen. Bitte normal einloggen.", null);
  });

  // Passwort Login
  document.getElementById("btnLoginPw").addEventListener("click", async () => {
    const msg = document.getElementById("loginMsg");
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    if (!email) return setMsg(msg, "Bitte E-Mail eingeben.", "bad");
    if (!password) return setMsg(msg, "Bitte Passwort eingeben.", "bad");

    setMsg(msg, "Login…", null);

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) return setMsg(msg, "Fehler: " + error.message, "bad");

    setStatus(true);
    setMsg(msg, "✅ Eingeloggt. Weiterleitung…", "ok");
    window.location.replace(APP_REDIRECT);
  });

  // Magic Link
  document.getElementById("btnMagicLink").addEventListener("click", async () => {
    const msg = document.getElementById("loginMsg");
    const email = document.getElementById("email").value.trim();

    if (!email) return setMsg(msg, "Bitte E-Mail eingeben.", "bad");

    setMsg(msg, "Sende Login-Link…", null);

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: REDIRECT_TO }
    });

    if (error) return setMsg(msg, "Fehler: " + error.message, "bad");
    setMsg(msg, "✅ E-Mail gesendet. Bitte Postfach prüfen.", "ok");
  });

  // Passwort vergessen
  document.getElementById("btnForgotPw").addEventListener("click", async () => {
    const msg = document.getElementById("loginMsg");
    const email = document.getElementById("email").value.trim();

    if (!email) return setMsg(msg, "Bitte E-Mail eingeben.", "bad");

    setMsg(msg, "Sende Wiederherstellungs-Mail…", null);

    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: REDIRECT_TO });
    if (error) return setMsg(msg, "Fehler: " + error.message, "bad");

    setMsg(msg, "✅ E-Mail gesendet. Bitte Postfach prüfen.", "ok");
  });

  // Logout (nur sichtbar, falls du es später brauchst)
  document.getElementById("btnLogout").addEventListener("click", async () => {
    await sb.auth.signOut();
    setStatus(false);
    setMsg(document.getElementById("loginMsg"), "Ausgeloggt.", null);
  });

  window.addEventListener("load", init);
</script>
</body>
</html>
