<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FSBS Intern – Login</title>
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#120e18; --bg2:#1a1424; --bg3:#1f162c;
      --accent1:#f97316; --accent2:#a855f7;
      --glass: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --shadow: 0 20px 55px rgba(0,0,0,.45);
      --ok: rgba(34,197,94,.95);
      --bad: rgba(239,68,68,.95);
    }

    *{box-sizing:border-box}
    html, body{min-height:100%}

    html{
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(249,115,22,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(168,85,247,.22), transparent 60%),
        radial-gradient(800px 450px at 60% 90%, rgba(124,58,237,.18), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      background-attachment: fixed;
    }

    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color: var(--text);
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 42px 16px;
    }

    .app{ width: min(560px, 100%); }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }

    .brandLeft{ display:flex; align-items:center; gap:12px; min-width:0; }

    .brandLogo{
      width: 52px; height: 52px; border-radius: 14px; padding: 6px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 16px 44px rgba(0,0,0,.30);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      flex:0 0 auto;
      transition: transform .16s ease, filter .16s ease, background .16s ease;
      text-decoration:none;
      color: rgba(255,255,255,.92);
      font-weight:850;
    }
    .brandLogo:hover{ transform: translateY(-1px); filter: brightness(1.05); background: rgba(255,255,255,.12); }
    .brandLogo img{ width:100%; height:100%; border-radius: 10px; object-fit:cover; display:block; }

    .titles h1{ margin:0; font-size:22px; letter-spacing:.25px; line-height:1.15; }
    .subtitle{ margin-top:4px; color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .glass{
      background: rgba(255,255,255,.10);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .card{ padding:18px; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.15);
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{ width:9px; height:9px; border-radius:50%; background: rgba(255,255,255,.35); box-shadow: 0 0 0 3px rgba(255,255,255,.06); }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    label{ display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
      outline:none;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    input:focus{
      border-color: rgba(249,115,22,.55);
      background: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }
    input::placeholder{ color: rgba(255,255,255,.55); }

    .grid{ display:grid; gap:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button{
      border:none; cursor:pointer;
      border-radius:14px;
      padding: 12px 16px;
      font-weight:650;
      transition: transform .16s ease, filter .16s ease, opacity .16s ease, box-shadow .16s ease, background .16s ease, border-color .16s ease;
    }
    button:active{ transform: translateY(0px) scale(.99); }
    button:disabled{ cursor:not-allowed !important; opacity:.55 !important; transform:none !important; filter:none !important; box-shadow:none !important; }

    .btn-primary{
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #0f0b16;
      box-shadow: 0 12px 30px rgba(168,85,247,.25);
    }
    .btn-primary:hover{
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow:
        0 18px 36px rgba(249,115,22,.25),
        0 0 40px rgba(168,85,247,.25);
    }

    .btn-secondary{
      background: rgba(255,255,255,.14);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.18);
    }
    .btn-secondary:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.26);
    }

    .note{ font-size:13px; color: var(--muted); line-height:1.45; }

    .msg{ margin-top:10px; font-size:13px; color: var(--muted); min-height:18px; }
    .msg.ok{ color: rgba(34,197,94,.95); }
    .msg.bad{ color: rgba(239,68,68,.95); }

    footer{ margin-top:14px; text-align:center; color: rgba(255,255,255,.55); font-size: 12px; }
    footer strong{ color: rgba(255,255,255,.78); font-weight: 750; }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brandLeft">
        <a class="brandLogo" href="index.html" title="Fachschaft Business School e.V.">
          <img src="logo.png" alt="Fachschaft Logo"
               onerror="this.style.display='none'; this.parentElement.textContent='FS';" />
        </a>
        <div class="titles">
          <h1>FSBS Intern</h1>
          <div class="subtitle">Vorstand & Ressortleitung · Login per Mail-Link</div>
        </div>
      </div>

      <div class="badge" title="Login-Status">
        <span class="dot bad" id="statusDot"></span>
        <span id="statusText">nicht eingeloggt</span>
      </div>
    </div>

    <div class="glass card">
      <div class="grid">
        <div>
          <label for="email">E-Mail</label>
          <input id="email" type="email" autocomplete="email" placeholder="name@domain.de" />
        </div>

        <div class="row">
          <button class="btn-primary" id="btnSend">Login-Link senden</button>
          <button class="btn-secondary" id="btnResend" disabled>Erneut senden</button>
        </div>

        <div class="note">
          Du bekommst einen sicheren Login-Link per E-Mail. Link klicken → du wirst automatisch eingeloggt und ins Portal weitergeleitet.
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </div>

    <footer>
      <strong>Fachschaft Business School e.V.</strong> · portal.fsbs-hm.de
    </footer>
  </div>

<script>
  const SUPABASE_URL = "https://hdhueuihmxbskiusenpe.supabase.co";
  const SUPABASE_KEY = "sb_publishable_H6YjVStNvwY-VnZuZCYDxw_mOWEvAAW";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const APP_REDIRECT = "index.html";
  const EMAIL_REDIRECT_TO = "https://portal.fsbs-hm.de/login.html";

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const msgEl = document.getElementById("msg");
  const emailEl = document.getElementById("email");
  const btnSend = document.getElementById("btnSend");
  const btnResend = document.getElementById("btnResend");

  function setStatus(isAuthed){
    statusDot.classList.toggle("ok", !!isAuthed);
    statusDot.classList.toggle("bad", !isAuthed);
    statusText.textContent = isAuthed ? "eingeloggt" : "nicht eingeloggt";
  }
  function setMsg(text, kind){
    msgEl.textContent = text || "";
    msgEl.classList.remove("ok","bad");
    if (kind) msgEl.classList.add(kind);
  }

  function getParam(name){
    const fromHash = new URLSearchParams((location.hash || "").replace(/^#/, ""));
    const fromQuery = new URLSearchParams(location.search || "");
    return fromHash.get(name) ?? fromQuery.get(name);
  }

  function cleanUrlAll(){
    const clean = location.origin + location.pathname;
    history.replaceState(null, "", clean);
  }

  async function handleCallbackIfNeeded(){
    // PKCE: ?code=... -> exchange
    const code = getParam("code");
    if (code){
      const { error } = await sb.auth.exchangeCodeForSession(location.href);
      if (error){
        setMsg("Fehler beim Login-Link: " + error.message, "bad");
        return;
      }
      cleanUrlAll();
    }

    // Token-Hash: falls Supabase das nutzt, Hash entfernen sobald Session existiert
    const { data: { session } } = await sb.auth.getSession();
    if (session){
      setStatus(true);
      if (location.hash || location.search) cleanUrlAll();
      // ✅ direkt ins Portal
      window.location.replace(APP_REDIRECT);
      return;
    }

    setStatus(false);
  }

  async function sendMagicLink(){
    const email = emailEl.value.trim();
    if (!email) return setMsg("Bitte E-Mail eingeben.", "bad");

    btnSend.disabled = true;
    btnResend.disabled = true;
    setMsg("Sende Login-Link…", null);

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: EMAIL_REDIRECT_TO }
    });

    btnSend.disabled = false;

    if (error){
      setMsg("Fehler: " + error.message, "bad");
      return;
    }

    setMsg("✅ Mail gesendet. Bitte Link in der E-Mail klicken.", "ok");

    // Resend erst nach kurzer Zeit aktivieren (Spam-Schutz)
    let sec = 15;
    btnResend.disabled = true;
    btnResend.textContent = `Erneut senden (${sec}s)`;
    const t = setInterval(()=>{
      sec--;
      if (sec <= 0){
        clearInterval(t);
        btnResend.disabled = false;
        btnResend.textContent = "Erneut senden";
        return;
      }
      btnResend.textContent = `Erneut senden (${sec}s)`;
    }, 1000);
  }

  btnSend.addEventListener("click", sendMagicLink);
  btnResend.addEventListener("click", sendMagicLink);

  // init
  (async ()=>{
    await handleCallbackIfNeeded();
  })();
</script>
</body>
</html>
